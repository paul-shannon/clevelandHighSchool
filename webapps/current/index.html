




<!DOCTYPE html>
<html>

<head>
   <meta charset="UTF-8">
   <meta property="og:title" content="Oncoscape" />

   <script src="http://code.jquery.com/qunit/qunit-1.18.0.js"></script>
   <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.18.0.css">

   <!-- script   src="https://code.jquery.com/jquery-1.12.3.min.js"></script -->
   <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>


   <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.7/themes/smoothness/jquery-ui.css">

   <script src="http://cytoscape.github.io/cytoscape.js/api/cytoscape.js-latest/cytoscape.min.js"></script>

  <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.js"></script>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-qtip/2.2.5/cytoscape-qtip.js"></script>



   <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>

   <script src="http://oncoscape-static.s3-website-us-west-2.amazonaws.com/js/jquery.dataTables-1.10.5.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://oncoscape-static.s3-website-us-west-2.amazonaws.com/css/jquery.dataTables-1.10.5.min.css">

   <script src="http://cdn.datatables.net/colvis/1.1.0/js/dataTable.colVis.js"></script>

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colvis/1.1.0/css/dataTables.colVis.css">

   <script src="http://oncoscape-static.s3-website-us-west-2.amazonaws.com/js/jquery.multi-select.js" type="text/javascript"></script>
   <link href="http://oncoscape-static.s3-website-us-west-2.amazonaws.com/css/multi-select.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://oncoscape-static.s3-website-us-west-2.amazonaws.com/js/chosen.jquery.min.js" type="text/javascript"></script>
   <link href="http://oncoscape-static.s3-website-us-west-2.amazonaws.com/css/chosen.min.css" media="screen" rel="stylesheet" type="text/css">

    <link rel="SHORTCUT ICON" type="image/x-icon" href="http://oncoscape-static.s3-website-us-west-2.amazonaws.com/images/favicon.ico"/>
    <link rel="ICON" type="image/x-icon" href="http://oncoscape-static.s3-website-us-west-2.amazonaws.com/images/favicon.ico"/>


<script>
//--------------------------------------------------------------------------------------------------
// hooks for google analytics

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-528883-29', 'auto');
  ga('send', 'pageview');
//--------------------------------------------------------------------------------------------------
</script>

<script>
navigator.sayswho= (function(){
    var ua= navigator.userAgent, tem,
    M= ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
    if(/trident/i.test(M[1])){
        tem=  /\brv[ :]+(\d+)/g.exec(ua) || [];
        return 'IE '+(tem[1] || '');
    }
    if(M[1]!== 'Chrome'){
       alert("Oncoscape is currently developed and tested under Chrome.  For best results, please use Chrome version 45.0 and later.")
        tem= ua.match(/\b(OPR|Edge)\/(\d+)/);
        if(tem!= null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
    }
    M= M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
    if((tem= ua.match(/version\/(\d+)/i))!= null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();
</script>

</head>

<style>

.flex-container {
  display: -webkit-flex;
  display: flex;
  }

.ui-slider-range {
   background-image: none;
   background: lightgrey;
   }

th,td {
   font-size:12px;
   }

.patientDataFilterSliderReadout{
   font-size: 10px;
   height:16px;
   }

.ui-tabs .ui-tabs-nav li a{
   font-size:10pt !important;
   }

.ui-button .ui-button-text{
   font-size:10pt !important;
   }

.ui-dialog .ui-dialog-titlebar-close span{ margin:0 }

.SelectionMenu{
color: rgb(0, 0, 0); 
background-color: rgb(255, 255, 255);
}

</style>


<style>
.extent {
  fill-opacity: .1;
  stroke: #f00;
  }

.domain {
  fill: none;
  stroke: black;
  stroke-width; 1;
  }
</style>


<title>Cleveland</title>

<script>
//----------------------------------------------------------------------------------------------------
// These javascript functions and variables are arranged into a simple module so that
// implementation details are kept private from the public API other chinook
// browser modules will use.  common services and utility functions are provided here
//----------------------------------------------------------------------------------------------------
var HubModule = (function () {

  var name = "HubModule";
     // keys are module names, their outermost divs are the values.
     // providing these outermost divs allows was inspired by
     // the need to allow raising of tabs by the sending tab.
     // TODO: not sure that's still needed

  var selectionDestinations = {};
  var dispatchOptions = {};
  var socketIsConnected = false;
  var socketConnectedFunctions = [];
  var onDocumentReadyFunctions = [];
  var socketURI = window.location.href.replace("http://", "ws://");
  var socket;

  var  messagingRestrictedToLogin = false;

  var modules = {};
//----------------------------------------------------------------------------------------------------
function registerModule(name, moduleObject)
{
   modules[name] = moduleObject;

} // registerModule
//----------------------------------------------------------------------------------------------------
function getModuleNames()
{
   return(Object.getOwnPropertyNames(modules));

} // getModuleNames
//----------------------------------------------------------------------------------------------------
function getModules()
{
   return modules;

} // getModules
//----------------------------------------------------------------------------------------------------
// TODO: add 3rd argument: acceptsIncomingMessages
//       datasets, for instance, seems to have no need for incoming json/websocket messages
function registerSelectionDestination(names, outermostDivID)
{
  if(typeof(names) == "string")
    names = [names];

  for(var i=0; i < names.length; i++)
     selectionDestinations[names[i]] = outermostDivID;

} // registerSelectionDestination
//----------------------------------------------------------------------------------------------------
function getRegisteredSelectionDestinations()
{
  return(selectionDestinations);

} // getRegisteredSelectionDestinations
//----------------------------------------------------------------------------------------------------
function setupSocket(socket)
{
  console.log("=== Module.hub setupSocket");

  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        socketIsConnected = true;
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } // socked.onopen

     socket.onmessage = function got_packet(msg) {
        var msg = JSON.parse(msg.data)
        dispatchMessage(msg)
        } // socket.onmessage, got_packet

     socket.onclose = function(){
        var msg = "Web socket connection to server has closed";
        console.log(msg);
        //alert(msg);
        } // socket.onclose
     } // try
  catch(exception) {
    console.log("Error: " + exception);
    }

  return(socket);

} // setupSocket
//----------------------------------------------------------------------------------------------------
function socketConnected()
{
   return(socketIsConnected);

} // socketConnected
//----------------------------------------------------------------------------------------------------
function addSocketConnectedFunction(func)
{
   socketConnectedFunctions.push(func)

} // addSocketConnectedFunction
//----------------------------------------------------------------------------------------------------
function getSocketConnectedFunctions()
{
   return(socketConnectedFunctions)

} // getSocketConnectedFunction
//----------------------------------------------------------------------------------------------------
function addOnDocumentReadyFunction(func)
{
   onDocumentReadyFunctions.push(func)

} // addOnDocumentReadyFunction
//----------------------------------------------------------------------------------------------------
function getOnDocumentReadyFunctions()
{
   return(onDocumentReadyFunctions)

} // getOnDocumentReadyFunctions
//----------------------------------------------------------------------------------------------------
// the nginx proxy server, used by fhcrc IT for the publicly-visible version of Chinook
// times out web sockets at 90 seconds.
// this function, when called more often that that, will keep the websocket open.
keepAlive = function()
{
    //console.log("keep alive");
    msg = {cmd: "keepAlive", callback: "", status:"request", payload:""}
    socket.send(JSON.stringify(msg));

} // keepAlive
//--------------------------------------------------------------------------------------------------
function runOnDocumentReadyFunctions()
{
  setInterval(keepAlive, 10000);  // 10 seconds
  var funcs = getOnDocumentReadyFunctions()
  console.log("==== Module.hub: " + funcs.length + " onDocumentReadyFunctions");

  for (var f = 0; f < funcs.length; f++) {
     console.log("calling on ready function");
     funcs[f]();
     }

} // runOnDocumentReadyFunctions
//----------------------------------------------------------------------------------------------------
function runningInNode()
{
    // a not very sophisticated test, but adequate for our purposes thus far
  return(typeof(window) == "undefined")

} // functionRunningInNode
//----------------------------------------------------------------------------------------------------
function initializeWebSocket() // socketURI)
{
   if(runningInNode()){
     console.log("--- web socket not currently available when runing in Node");
     process.exit(code=1)
     }

   socket = new WebSocket(socketURI);
   socket = setupSocket(socket);

} // initializeWebSocket
//----------------------------------------------------------------------------------------------------
function getSocket()
{
  return(socket);

} // getSocket
//----------------------------------------------------------------------------------------------------
function addMessageHandler(cmd, func)
{
  if(cmd in dispatchOptions){
     dispatchOptions[cmd].push(func)
     }
  else{
     dispatchOptions[cmd] = [func]
     }

} // addMessageHandler
//----------------------------------------------------------------------------------------------------
function getRegisteredMessageNames()
{
   return(Object.keys(dispatchOptions));

} // getRegisteredMessageNames
//----------------------------------------------------------------------------------------------------
function getDispatchOptions()
{
   return(dispatchOptions);

} // getDispatchOptions
//----------------------------------------------------------------------------------------------------
function dispatchMessage(msg)
{
   var cmd = msg.cmd;
   var status = msg.status;
   console.log("====== Module.hub dispatchMessage '" + cmd + "' [" + Date() + "]" );

   var dispatchKeys = Object.keys(dispatchOptions);
   var cmdIndex = dispatchKeys.indexOf(cmd);
   console.log("hub.dispatchMessage(" + cmd + "): " + cmdIndex);

   if(cmdIndex === -1){
      console.log("unrecognized socket request: " + msg.cmd);
      console.log(" --- msg:");
      console.log(msg);
      console.log(" --- dispatchOptions");
      console.log(dispatchOptions);
      }
   else{
     var funcs = dispatchOptions[cmd];
     //console.log(" func count for msg cmd " + cmd + ": " + funcs.length);
      for(var i=0; i < funcs.length; i++){
         //console.log("--- Module.hub executing func # " + i + " for cmd " + msg.cmd);
         funcs[i](msg); // dispatchOptions[msg.cmd](msg)
         } // for i
      }

}  // dispatchMessage
//----------------------------------------------------------------------------------------------------
function restrictMessagingToLogin(newState)
{
   messagingRestrictedToLogin = newState;

} // restrictMessagingToLogin
//----------------------------------------------------------------------------------------------------
function send(msg)
{
   var cmd = JSON.parse(msg).cmd;
   if(messagingRestrictedToLogin && cmd === "checkPassword"){
      console.log("hub.send drops non-login msg");
      return;
      }

   var browserLocalCommand = Object.keys(dispatchOptions).indexOf(cmd) >= 0;
   var mode = "server";
   if(browserLocalCommand)
      mode = "browser local";

   console.log("--- hub.send: '" + cmd + "' (" + mode + ")");

   if(browserLocalCommand)
      dispatchMessage(JSON.parse(msg));
   else{
      socket.send(msg);
      }

}  // send
//----------------------------------------------------------------------------------------------------
function setTitle (newTitle)
{
  window.document.title = newTitle;

}  // setTitle
//----------------------------------------------------------------------------------------------------
// add a pulldown menu to the specified menuSelector, which has been provided by the caller, which
// is assumed to be an Chinook module.  append the names of all previously-registered divs,
// except for those explicitly excluded in the incoming argument "excludedModules".
// This supports the usual (but not universal) case: a module does not want to send selections
// to itself.
// this argument will often be an array of one element, the name of the calling module.
// some modules may have multiple send destinations (eg, "PCA" & "PCA (highlight)".
function configureSendSelectionMenu(menuSelector, excludedModules, changeFunction, menuTitle)
{
  var menu = $(menuSelector);
  menu.append("<option>" + menuTitle + "</option>");
  menu.change(changeFunction);
  var otherModules = Object.keys(hub.getRegisteredSelectionDestinations());

  for(var i=0; i < otherModules.length; i++){
     var moduleName = otherModules[i];
     var excluded = excludedModules.indexOf(moduleName) >= 0;
     if(!excluded){
        menu.append("<option>" + moduleName + "</option>");
        }
     } // for i

  return(menu);

} // createSendSelectionMenu
//--------------------------------------------------------------------------------------------
// from http://stackoverflow.com/questions/4068373/center-a-popup-window-on-screen
function openCenteredBrowserWindow(url, title, w, h, replaceAnyExistingPopup) {
      // Fixes dual-screen position                       Most browsers      Firefox
    var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
    var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;
    width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
    height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

    var left = ((width / 2) - (w / 2)) + dualScreenLeft;
    var top = ((height / 2) - (h / 2)) + dualScreenTop;
    var options = 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left;

    var newWindow;

      // warning, a bug: when multiple popup windows are created, they
      // all have the same content -- not what we want.  fix this
      // by severing their relationship, and/or switching to jQuery dialog

    if(replaceAnyExistingPopup)
      newWindow = window.open(url, title, options);
    else // leave any existing popup windows untouched
      newWindow = window.open(url, "_blank", options);

    if (window.focus) {
       newWindow.focus();
       }

    return newWindow;

} // openCenteredBrowserWindow
//--------------------------------------------------------------------------------------------
function disableButton(button)
{
   button.prop("disabled", true);
   button.css({"background-color": "lightgray", "color": "gray"});

} // disableButton
//--------------------------------------------------------------------------------------------
function enableButton(button)
{
   button.prop("disabled", false);
   //button.css({ 'color': 'black'})
   button.css({"background-color": "white", "color": "black"});

} // enableButton
//--------------------------------------------------------------------------------------------
function disableAllTabsExcept(tabIDstring)
{
  if(typeof tabIDstring == "string") tabIDstring = [tabIDstring]
  var allDivIDs = getTabDivIDs()
  allDivIDs = allDivIDs.filter(function(i, id){ return(tabIDstring.indexOf(id) == -1) })
  for(var i=0;i<allDivIDs.length; i++){  	disableTab(allDivIDs[i]) }

  return allDivIDs;  //returns divIDs that have been disabled

} // disableTab
//--------------------------------------------------------------------------------------------
function disableTab(tabIDstring)
{
  $( "#chinookTabs" ).tabs( "disable", "#" + tabIDstring  )

} // disableTab
//--------------------------------------------------------------------------------------------
function enableTab(tabIDstring)
{
  $( "#chinookTabs" ).tabs( "enable", "#" + tabIDstring   )

} // enableTab
//--------------------------------------------------------------------------------------------
// if jQuery-style tabs are in use with Chinook, this function raised the named tab to the
// the front (visible) position in the tabset
// the argument, "tabIDString" is the tab id used in the module's widget.html, reproduced exactly
// in tabsApp/widget.html, with some current examples being
//  pcaDiv, patientTimeLinesDiv, gbmPathwaysDiv
//
function raiseTab(tabIDString)
{
  var tabsWidget = $("#chinookTabs");

  if(tabsWidget.length > 0){
     var selectionString = '#chinookTabs a[href="#' + tabIDString + '"]';
     var tabIndex = $(selectionString).parent().index ();
     if(tabIndex < 0) throw "Module.hub does not recognize tabIDString '" + tabIDString + "'";
     console.log("Module.hub:raiseTab for '" + tabIDString + "' (" + tabIndex + ") set to active'");
     setTimeout(function(){tabsWidget.tabs( "option", "active", tabIndex);}, 0);
     } // if tabs exist

} // raiseTab
//----------------------------------------------------------------------------------------------------
// each of our tabs is a div, nested directly within $("chinookTabs").
// this function returns an array of each of the div ids
function getTabNames()
{
  var tabNames = $("#chinookTabs").children()[0].textContent.trim().split("\n")
  for (i=0;i< tabNames.length; i++){ tabNames[i] = tabNames[i].trim()}
  tabNames =tabNames.filter(function(name){return name != ""})

	return tabNames;

} // getTabDivIDs
//----------------------------------------------------------------------------------------------------
// each of our tabs has a title within the $("chinookTabs") nav bar
// this function returns an array of each tab Title
function getTabDivIDs()
{
   return ($("#chinookTabs").children("div").map(function(index,dom){return dom.id}));

} // getTabDivIDs
//----------------------------------------------------------------------------------------------------
// e.g., hub.hideTab("Login", "#loginDiv");
function hideTab(tabTitle, tabDivIDstring)
{
  $(".ui-tabs-nav li:contains('" + tabTitle + "')").hide()
  $(tabDivIDstring).hide();

} // hideTab
//----------------------------------------------------------------------------------------------------
// e.g., hub.hideTabNav("Login");
function hideTabNav(tabTitle)
{
  $(".ui-tabs-nav li:contains('" + tabTitle + "')").hide()

} // hideTab
//----------------------------------------------------------------------------------------------------
function hideAllTabsButOne(tabTitle, tabDivIDstring)
{
  var divIDs = getTabDivIDs();

  $(".ui-tabs-nav li:contains('" + tabTitle + "')").hide()
  $(tabDivIDstring).hide();

} // hideAllTabsButOne
//----------------------------------------------------------------------------------------------------
function showTab(tabTitle, tabDivIDstring)
{
  $(".ui-tabs-nav li:contains('" + tabTitle + "')").show()
  $(tabDivIDstring).show();

} // showTab
//----------------------------------------------------------------------------------------------------
function addTab(tabTitle, tabDivIDstring,  content)
{
  var tabs = $("#chinookTabs").tabs()
  var listItem = "<li><a href='#" + tabDivIDstring + "}'>" + tabTitle + "</a>";

  tabs.find(".ui-tabs-nav").append(listItem);
  tabs.append("<div id='" + tabDivIDstring + "'><p>" + content + "</p></div>");
  tabs.tabs("refresh");

} // addTab
//----------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max)
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
String.prototype.beginsWith = function (string)
{
    return(this.toLowerCase().indexOf(string.toLowerCase()) === 0);
};
//----------------------------------------------------------------------------------------------------
uniqueElementsOfArray = function(vector)
{
  var u = {}, a = [];

  for(var i = 0, l = vector.length; i < l; ++i){
     if(u.hasOwnProperty(vector[i])){
       continue;
       }
     a.push(vector[i]);
     u[vector[i]] = 1;
     } // for i

   return a;

} // uniqueElementsOfArray
//----------------------------------------------------------------------------------------------------
// return the targets matched by the candidates, where match is tolerant of differences by suffix
// thus incoming id "TCGA.06.0649.01" matches existing id "TCGA.06.0649" and
//      incoming id "TCGA.06.0649"    matches existing id "TCGA.06.0649.01"
// this may cause problems with gene names, eg, MYC would mach MYCL and MYCA
// todo: make this suffix-tolerant match suffix-specific
function intersectionOfArrays(candidates, targets) {

  hits=[];

  for(var i=0; i < candidates.length; i++){
    for (var j=0; j < targets.length; j++){
       candidate = candidates[i];
       target = targets[j];
       index1 = candidate.indexOf(target);   // "abc".indexOf("ab") -> 0
       index2 = target.indexOf(candidate);
       //console.log("c(t): " + candidate + " contains " + target + ": " + index1);
       //console.log("t(c): " + target + " contains " + candidate + ": " + index2);
       if (index1 == 0)
          hits.push(target)
       else if (index2 == 0)
          hits.push(target)
         } // for j
     } // for i

  return(hits)

} // intersectionOfArays
//----------------------------------------------------------------------------------------------------
function setupGlobalExceptionHandler()
{
   window.onerror = function (errorMsg, url, lineNumber, column, errorObj) {

      var title = "Chinook Error";
      var options = {buttons: { "Ok": function () { $(this).dialog("close"); } },
                     title: title};
      var text = "<i>" + errorMsg + "</i><br>" +
                 "<br><b>Script</b>: " + url +
                 "<br><b>Line:</b> " + lineNumber +
                 "<br><b>Column:</b> " + column +
                 "<br><b>StackTrace:</b> " +  errorObj;
      $("<div></div>").dialog(options).html(text);
      };

} // setupGlobalExceptionHandler
//----------------------------------------------------------------------------------------------------
function start() // socketURI)
{
  setupGlobalExceptionHandler();
  initializeWebSocket(); // socketURI);
  $(document).ready(runOnDocumentReadyFunctions);
  QUnit.config.altertitle = false;

}  // start
//----------------------------------------------------------------------------------------------------
function logEventOnServer(moduleOfOrigin, eventName, eventStatus, comment)
{
   console.log("about to logEvent: " + eventName);
   payload= {eventName: eventName, eventStatus: eventStatus,
             moduleOfOrigin: moduleOfOrigin, comment: comment};

   hub.send(JSON.stringify({cmd: "logEvent", callback: "", status: "request", payload: payload}));

} // logEventOnServer
//----------------------------------------------------------------------------------------------------
function test_intersectionOfArrays()
{
   console.log("---  test_intersectionOfArrays");
   var targets = ["TCGA.02.0006"];
   var candidates = ["TCGA.02.0006"];

   QUnit.test("test_intersectionOfArrays 1", function(assert) {
      assert.equal(hub.intersectionOfArrays(candidates, targets), candidates);
      });

   targets = ["TCGA.02.0006"];
   candidates = ["bogus"];
   QUnit.test("test_intersectionOfArrays 2", function(assert) {
      assert.equal(hub.intersectionOfArrays(candidates, targets), []);
      });

   targets = ["bogus"];
   candidates = ["TCGA.02.0006"];
   QUnit.test("test_intersectionOfArrays 3", function(assert) {
      assert.equal(hub.intersectionOfArrays(candidates, targets), []);
      });


   targets = ["TCGA.02.0006.01"];
   candidates = ["TCGA.02.0006"];
   QUnit.test("test_intersectionOfArrays 4", function(assert) {
      assert.equal(hub.intersectionOfArrays(candidates, targets), candidates);
      });

   //targets = ["MAP2"];   this test will fail because sometimes we want incomplete matches:
   //  see test4 just above
   //candidates = ["MAP2K4", "abc"];
   //QUnit.test("test_intersectionOfArrays 5", function(assert) {
   //   assert.equal(hub.intersectionOfArrays(candidates, targets), []);
   //   });


} //  test_intersectionOfArrays
//----------------------------------------------------------------------------------------------------
function standAloneTest()
{
   test_intersectionOfArrays();

}  // standaloneTest
//----------------------------------------------------------------------------------------------------

  return({
     getName: function() {return(name)},
     restrictMessagingToLogin: restrictMessagingToLogin,
     registerModule: registerModule,
     getModules: getModules,
     registerSelectionDestination: registerSelectionDestination,
     getRegisteredSelectionDestinations: getRegisteredSelectionDestinations,
     socketConnected: socketConnected,
     addSocketConnectedFunction: addSocketConnectedFunction,
     getSocketConnectedFunctions: getSocketConnectedFunctions,
     addOnDocumentReadyFunction: addOnDocumentReadyFunction,
     getOnDocumentReadyFunctions: getOnDocumentReadyFunctions,
     runningInNode: runningInNode,
     initializeWebSocket: initializeWebSocket,
     getSocket: getSocket,
     addMessageHandler: addMessageHandler,
     getRegisteredMessageNames: getRegisteredMessageNames,
     getDispatchOptions: getDispatchOptions,
     dispatchMessage: dispatchMessage,
     configureSendSelectionMenu: configureSendSelectionMenu,
     openCenteredBrowserWindow: openCenteredBrowserWindow,
     enableButton: enableButton,
     disableButton: disableButton,
     enableTab: enableTab,
     disableTab: disableTab,
     disableAllTabsExcept: disableAllTabsExcept,
     getRandomInt: getRandomInt,
     getRandomFloat: getRandomFloat,
     intersectionOfArrays: intersectionOfArrays,
     uniqueElementsOfArray: uniqueElementsOfArray,
     send: send,
     setTitle: setTitle,
     getTabDivIDs: getTabDivIDs,
     getTabNames: getTabNames,
     raiseTab: raiseTab,
     hideTab: hideTab,
     hideTabNav: hideTabNav,
     showTab: showTab,
     addTab: addTab,
     sat: standAloneTest,
     start: start,
     logEventOnServer: logEventOnServer
     });

}); // HubModule
//----------------------------------------------------------------------------------------------------


var hub = HubModule();
hub.addOnDocumentReadyFunction(function() {
  $("#chinookTabs").tabs();
  hub.raiseTab("datasetsDiv");
  hub.disableAllTabsExcept("datasetsDiv"); 
  })

hub.start();

</script>
<body>
<script>
//----------------------------------------------------------------------------------------------------
var DataSummaryModule = (function () {

  var dataSummaryDiv;

  var outputDiv;
  var dataSetNamesOutputDiv;
  var thisModulesName = "Datasets";
  var thisModulesOutermostDiv = "datasetsDiv";

  var tableElement;
  var tableRef;
  var datasetMenu;
  var selectedDataset;
  var useThisDatasetButton;

  var sendSelectionsMenu;
  var sendSelectionsMenuTitle = "Send selection...";
  var passwordProtected = false;

//----------------------------------------------------------------------------------------------------
function initializeUI()
{
  sendSelectionsMenu = hub.configureSendSelectionMenu("#datasetsSendSelectionsMenu",
                                                      [thisModulesName], sendSelections,
                                                       sendSelectionsMenuTitle);

  hub.disableButton(sendSelectionsMenu);

  $(window).resize(handleWindowResize);
  datasetMenu = $("#datasetMenu");
  datasetMenu.change(selectManifest);

  dataSetNamesOutputDiv = $("#dataSetNamesOutputDiv");
  dataSummaryDiv = $("#dataSummaryOutputDiv");

  useThisDatasetButton = $("#selectDatasetButton");
  useThisDatasetButton.button();
  //hub.disableButton(useThisDatasetButton);
  useThisDatasetButton.click(specifyCurrentDataset);

  outputDiv = $("#dataSummaryOutputDiv");
  tableElement = $("#datasetsManifestTable");

    // if no login tab is present, then allow unrestricted choice of datasets.
    // if it IS present, then that tab will control this.

  var loginRequired = $("#loginDiv").length === 1;
  console.log("loginRequired? " + loginRequired);

  if(!loginRequired){
    console.log(" enabling datasetMenu");
    hub.enableButton($("#datasetMenu"));
    }
  else{
    console.log(" disabling datasetMenu");
    hub.disableButton($("#datasetMenu"));
    }

   if(hub.socketConnected())
      populateDatasetMenu();
   else
     hub.addSocketConnectedFunction(populateDatasetMenu);

} // initializeUI
//----------------------------------------------------------------------------------------------------
function postStatus(msg)
{
   $("#datasetsStatusDiv").text(msg);   // todo: this is obsolete
   $("#datasetsMinorStatusDiv").text(msg);

} // postStatus
//----------------------------------------------------------------------------------------------------
function handleWindowResize()
{
  $("#"+thisModulesOutermostDiv).width($(window).width() * 0.95);
//  $("#"+thisModulesOutermostDiv).height($(window).height() * 0.95);

//  console.log("  div: " + outputDiv.width());
//  console.log("  tbl before: " + tableElement.width());
//  tableElement.width($(window).width() * 0.50);
//  console.log("  tbl after: " + tableElement.width());

} // handleWindowResize
//----------------------------------------------------------------------------------------------------
function sendSelections(event)
{
   var destination = sendSelectionsMenu.val();
   console.log("send selections to " + destination);
   sendSelectionsMenu.val(sendSelectionsMenuTitle);

   var cmd = "sendSelectionTo_" + destination;
   payload = "dummy payload";
   var newMsg = {cmd: cmd,  callback: "", status: "request", payload: payload};

   sendSelectionsMenu.val(sendSelectionsMenuTitle);

   hub.send(JSON.stringify(newMsg));

} // sendSelections
//----------------------------------------------------------------------------------------------------
function selectManifest(event)
{
   selectedDataset = datasetMenu.val();
   console.log("dataset '" + selectedDataset + "'");

   if(selectedDataset === ""){
      $("#datasetInstructions").css("display", "block");
      $("#datasetsManifestTable").css("display", "none");
      hub.disableButton(useThisDatasetButton);
      }
    else{
      $("#datasetInstructions").css("display", "none");
      $("#datasetsManifestTable").css("display", "block");
      requestDatasetSummary(selectedDataset);
      }

} // selectManifest
//----------------------------------------------------------------------------------------------------
function populateDatasetMenu()
{
   console.log("Module.datasets, entering populateDatasetMenu");

   console.log("      socket connected? " + hub.socketConnected());
   console.log("=== datasetMenu ready, now issuing populateDatasetMenu request to server");
   var msg = {cmd: "getDatasetNames",  callback: "handleDatasetNames", status: "request", payload: ""};
   hub.send(JSON.stringify(msg));

} // populateDatasetMenu
//----------------------------------------------------------------------------------------------------
function handleDatasetNames(msg)
{
   console.log("=== handleDatasetNames");

   var dataSetNames = msg.payload.datasets;
   console.log("dataSetNames length: " + dataSetNames.length);
   console.log("dataSetNames: " + JSON.stringify(dataSetNames));

   var passwordProtected = msg.payload.passwordProtected;

   if(!Array.isArray(dataSetNames))
      dataSetNames = [dataSetNames];

   for(var i=0; i < dataSetNames.length; i++){
      var s = dataSetNames[i];
      datasetMenu.append("<option value='" + s + "'>" + s + "</option>");
      }

  //$("#datasetMenu").val(dataSetNames[0]);
  $("#datasetsMinorStatusDiv").text("datasetMenu loaded");
  // console.log("handleDatasetNames about to requestDatasetSummary")
  // requestDatasetSummary(dataSetNames[0]);

} // handleDatasetNames
//----------------------------------------------------------------------------------------------------
function requestDatasetSummary(datasetName)
{
   console.log("=== requestDatasetSummary");

   payload = {dataset: datasetName}
   var msg = {cmd: "getDataManifest",  callback: "displayDataManifest", status: "request",
              payload: payload};
   hub.logEventOnServer(thisModulesName, "datasets requestDataSummary", "request", datasetName);

   hub.send(JSON.stringify(msg));

} // requestDatasetSummary
//----------------------------------------------------------------------------------------------------
function displayDataManifest(msg)
{
   var payload = msg.payload;
   var tblColumnNames = payload.colnames;

   var columnTitles = [];
     // convert simple strings to array of objects, each an sTitle
   for(var i=0; i < tblColumnNames.length; i++){
      columnTitles.push({sTitle: tblColumnNames[i]});
      }

   if(typeof(tableRef) != "undefined"){
      tableRef.destroy();
      tableElement.empty();
      }


   $(tableElement).ready(function() {
      tableRef = tableElement.DataTable({
        //sDom: 't',
        aoColumns: columnTitles,
        //scrollX: true,
        bPaginate: false,
        bFilter: false,
        bAutoWidth: true,
        bSort: false,
        bInfo: false
        }); // dataTable

     tableRef = $("#datasetsManifestTable").DataTable();

     tableRef.rows.add(payload.mtx).draw();
     // tableRef.fnAddData(payload.mtx);

     $('#datasetsManifestTable tbody').on( 'click', 'tr', function (){
         console.log("=== click");
         var category = $('td', this).eq(0).text();
         var subcategory = $('td', this).eq(1).text();
         if($(this).hasClass("selected")){
            $(this).removeClass('selected');
            hub.disableButton(sendSelectionsMenu);
            }
         else{
            tableRef.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            hub.enableButton(sendSelectionsMenu);
            console.log("selected " + category + ", " + subcategory);
            }
         });

     handleWindowResize();
     hub.enableButton(useThisDatasetButton);
     postStatus("manifest table displayed");
     hub.logEventOnServer(thisModulesName, "datasets requestDataSummary", "complete", "");
     }); // tableElement.ready

} // displayDataManifest
//----------------------------------------------------------------------------------------------------
function specifyCurrentDataset()
{
   console.log("Module.datasets 'Use Dataset' button clicked, specifyCurrentDataset: " + selectedDataset);

   hub.disableAllTabsExcept([thisModulesOutermostDiv, "userDataStoreDiv"]);
   $("#loadingDatasetMessage").css("display", "inline");

   var msg = JSON.stringify({cmd: "specifyCurrentDataset",  callback: "datasetSpecified",
                            status: "request", payload: selectedDataset});

   console.log(msg)
   hub.send(msg);

} // specifyCurrentDataset
//----------------------------------------------------------------------------------------------------
function datasetSpecified(msg)
{
   $("#loadingDatasetMessage").css("display", "none");
   console.log("--- Module.datasets:  datasetSpecified");

} // datasetSpecified
//----------------------------------------------------------------------------------------------------
function test(dataSetName)
{
   console.log("Module.datasets test, on datasetName: '" + dataSetName + "'");

   QUnit.test("choose dataset '" + dataSetName + "'", function(assert) {
      hub.raiseTab("datasetsDiv");
      var desiredDataset = dataSetName;
      var dzNames = $("#datasetMenu option").map(function(opt){return this.value;});

      if($.inArray(desiredDataset, dzNames) < 0){
         alert("cannot run tests:  " + desiredDataset + " dataset not loaded");
         return;
         }

      $("#datasetMenu").val(desiredDataset);
      $("#datasetMenu").trigger("change");

      var done1 = assert.async();
      var done2 = assert.async();
      var done3 = assert.async();
      assert.expect(3);

      setTimeout(function(){
         assert.equal($("#datasetMenu").val(), desiredDataset);  done1();
         assert.ok($("#datasetsManifestTable tr").length >= 10); done2();
         assert.equal($("#datasetsManifestTable tbody tr").eq(0).find("td").eq(0).text(),
                      "mRNA expression"); done3();
         //testLoadPatientHistoryTable();
         }, 5000);
      });


} // test
//----------------------------------------------------------------------------------------------------
function moduleInit()
{
  hub.addOnDocumentReadyFunction(initializeUI);
  //hub.addSocketConnectedFunction(populateDatasetMenu);
  hub.addMessageHandler("handleDatasetNames", handleDatasetNames);
  hub.addMessageHandler("displayDataManifest", displayDataManifest);
  hub.addMessageHandler("datasetSpecified", datasetSpecified);

} // moduleInit
//----------------------------------------------------------------------------------------------------
return{
   init: moduleInit,
   test: test
   }; // DataSummaryModule return value

//----------------------------------------------------------------------------------------------------
}); // DataSummaryModule

var dataSummaryModule = DataSummaryModule();
dataSummaryModule.init();
hub.registerModule("Datasets", dataSummaryModule);

//----------------------------------------------------------------------------------------------------
var CorrelationPlotsModule = (function () {

  var datasetName = null;
  var plotTitleDiv;
  var plotDiv;
  var d3plotDiv;
  var selectedRegion;          // assigned out of brushReader function
  var selectedIDs=[];       // empty array, zipCodes 
  var dataReceived = false; // when true, window resize does replot of data
  var dataset;                 // assigned from payload of incoming plotxy message

  var fittedLine;              // assembled from payload yFit and x vector
  var regressionLine2 = null; //when != null, handleWindowResize resizes the line, second "fitted Line"

  var xMin, xMax, yMin, yMax;  // conveniently calculated in R, part of payload
  var datasetLength;
  var xAxisLabel, yAxisLabel, correlation;

  var sendSelectionsMenu;
  var thisModulesName = "CorrelationPlotter";
  var thisModulesOutermostDiv = "CorrelationPlotsDiv";

  var sendSelectionsMenuTitle = "Send selection...";

      // sometimes a module offers multiple selection destinations
      // but usually just the one entry point
  var selectionDestinations = [thisModulesName];
      // make sure to register, eg,
      // hub.addMessageHandler("sendSelectionTo_EnvironmentalMap", handleSelections);

  var recalculateRegression;

  var svg;
  var neighborhoodNames; 
  
//--------------------------------------------------------------------------------------------
function initializeUI()
{
  recalculateRegression = $("#recalculateRegression");
  recalculateRegression.click(sendingSelectedIDs); //sends selectedIDs to the hub
  hub.disableButton(recalculateRegression); // automatically disables button

  displayNeighborhoodNames = $("#displayNeighborhoodNames");
  displayNeighborhoodNames.click(displayingNeighborhoodNames); 
  
  plotTitleDiv = $("#correlationPlotTitleDiv");
  plotDiv = $("#correlationPlottingDiv");
  d3plotDiv = d3.select("#correlationPlottingDiv");
  console.log("div: " + plotDiv)
  $(window).resize(handleWindowResize);
  handleWindowResize();
  
}  // initializeUI
//----------------------------------------------------------------------------------------------------
function handleWindowResize ()
{
  plotTitleDiv.width(0.95 * $(window).width());
  plotTitleDiv.height("20px");
  plotDiv.width(0.95 * $(window).width());
  plotDiv.height(0.80 * $(window).height());
    
  // an easy way to rescale the canvas when the browser window size changes: just redraw
  if(dataReceived)
      d3plot(dataset, fittedLine, xMin, xMax, yMin, yMax, xAxisLabel, yAxisLabel, correlation);

  // redisplays the second line as the window size changes
  if (regressionLine2 != null )
     displayingSecondLine(dataset, regressionLine2, correlation2); 

} // handleWindowResize
//--------------------------------------------------------------------------------
function brushReader ()
{
    console.log("brushReader");

    selectedIDs=[];
	selectedRegion = d3brush.extent();
	x0 = selectedRegion[0][0];
	x1 = selectedRegion[1][0];
	width = Math.abs(x0-x1);
	if(width < 0.001) 
	    selectedRegion = null
	else{
	    getSelection(selectedIDs);}

} // d3PlotBrushReader
//--------------------------------------------------------------------------------
function d3plotPrep (msg)
{
  console.log("entering d3plotPrep");

  dataReceived = true;
  payload = msg.payload;

  // assign global variables
  dataset = [];
  datasetLength = payload.vec1.length;

  for(var i=0; i < datasetLength; i++){
    dataset.push({x: payload.vec1[i], y: payload.vec2[i], id: payload.entities[i]});
  }

  var yFit = msg.payload.yFit;
  var xFit = msg.payload.vec1;
  var lastElement = yFit.length - 1;

  fittedLine = {x1: xFit[0], y1: yFit[0], x2: xFit[lastElement], y2: yFit[lastElement]};

  xMin = msg.payload.vec1Min;
  xMax = msg.payload.vec1Max;
  yMin = msg.payload.vec2Min;
  yMax = msg.payload.vec2Max;

  xAxisLabel = msg.payload.vec1Name;
  yAxisLabel = msg.payload.vec2Name;
  correlation = msg.payload.correlation;   // between -1.0 and 1.0
  plotTitleDiv.html("<center> <i><b>" +
                     xAxisLabel + "</b></i> (x)  <i><b>vs.  " +
                     yAxisLabel + "</b></i>  (y) </br>  &nbsp;  correlation: " +
                     correlation +
                     "</center>");

  d3plot(dataset, fittedLine, xMin, xMax, yMin, yMax, xAxisLabel, yAxisLabel, correlation)

  //var return_msg = {cmd: msg.callback, status: "success", callback: "", payload: ""};
  //hub.send(return_msg);

} // d3plotPrep
//--------------------------------------------------------------------------------
function d3plot(dataset, fittedLine, xMin, xMax, yMin, yMax, xAxisLabel, yAxisLabel, correlation)
{
  var width = plotDiv.width();
  var height = plotDiv.height();

  padding = 50;
  xScale = d3.scale.linear()
             .domain([xMin,xMax])
             .range([padding,width-padding]);

  yScale = d3.scale.linear()
             .domain([yMin, yMax])
             .range([height-padding, padding]); // note inversion

  // must remove the svg from a d3-selected object, not just a jQuery object
  d3plotDiv.select("#plotSVG").remove();  // so that append("svg") is not cumulative 
    
    d3brush = d3.svg.brush()
        .x(xScale)
        .y(yScale)
        .on("brushend", brushReader); 

  svg = d3.select("#correlationPlottingDiv")
              .append("svg")
              .attr("id", "plotSVG")
              .attr("width", width)
              .attr("height", height)
              .call(d3brush);
    
  xAxis = d3.svg.axis()
                .scale(xScale)
                .ticks(10)
                .orient("bottom")
                .tickSize(10);

  yAxis = d3.svg.axis()
                .scale(yScale)
                .ticks(10)
                .tickSize(10)
                .orient("left");


  var xTranslationForYAxis = xScale(0);
  var yTranslationForXAxis = yScale(10);

  var tooltip = d3plotDiv.append("div")
                   .attr("class", "tooltip")
                   .style("position", "absolute")
                   .style("z-index", "10")
                   .style("visibility", "hidden")
                   .text("a simple tooltip");

  console.log("--- about to draw points, count: " + dataset.length);
  console.log(JSON.stringify(dataset))

  svg.selectAll("circle")
     .data(dataset)
     .enter()
	.append("circle")
                  .attr("class", "circles")

     .attr("cx", function(d){
       return xScale(d.x);
     })
     .attr("cy", function(d){
       return yScale(d.y);
     })
     .attr("r", function(d){
       return 5;
     })
     .style("fill", function(d){
       return "red";
     })
     .on("mouseover", function(d,i){   // no id assigned yet...
       tooltip.text(d.id);
       return tooltip.style("visibility", "visible");
     })
     .on("mousemove", function(){
       return tooltip.style("top",
         (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
       .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

  svg.append("g")
     .attr("class", "axis")
     .attr("transform", "translate(0," + (height - padding) + ")")
     .call(xAxis);

  svg.append("g")
     .attr("class", "axis")
     .attr("transform", "translate(" + padding + ",0)")
	.call(yAxis);

  console.log("--- about to draw regression line");
  console.log(JSON.stringify(fittedLine))

  svg.append("line")
     .style("stroke-width", 1)
     .style("stroke", "black")
     .style("stroke-dasharray", ("3, 3"))
     .attr("x1", xScale(fittedLine["x1"]))
     .attr("y1", yScale(fittedLine["y1"]))
     .attr("x2", xScale(fittedLine["x2"]))
     .attr("y2", yScale(fittedLine["y2"]));

   /**********
   svg.selectAll("line")
      .data(fittedLine)
      .enter().append("line")
      .attr("class", "line")
      .style("stroke-width", 1)
      .style("stroke", "green")
      .attr("x1", function(f) {var x1 = f["x0"]; console.log("f[0]: " + x1);  return xScale(x1);})
      .attr("y1", function(f) {var y1 = f["y0"]; console.log("f[1]: " + y1);  return yScale(y1);})
      .attr("x2", function(f) {var x2 = f["x1"]; console.log("f[2]: " + x2);  return xScale(x2);})
      .attr("y2", function(f) {var y2 = f["y1"]; console.log("f[3]: " + y2);  return yScale(y2);});
    *********/


    /*********
    svg.append("text")
      .attr("class", "x label")
      .attr("text-anchor", "end")
      .attr("x", xScale(40))
      .attr("y", yScale(50))
      .text(xAxisLabel);
    *********/


} // d3plot
//--------------------------------------------------------------------------------
function getSelection(selectedIDs)
{
  console.log("--- entering getSelection");   

  var selectedNames = [];
    
  if(selectedRegion == null)
  {
    var returnMsg = {cmd: msg.callback, callback: "", status: "success",
                        payload: selectedNames};
    console.log("=== returning from getSelection, no selected points");
    console.log(returnMsg);
    hub.send(returnMsg)
      return;
    hub.disableButton(recalculateRegression);
  }
    
  x0 = selectedRegion[0][0]
  x1 = selectedRegion[1][0]
  y0 = selectedRegion[0][1]
  y1 = selectedRegion[1][1]

  var datasetLength = dataset.length; //resets the length to the length of the dataset 
    
  for(var i=0; i < datasetLength; i++)
  {
    x = dataset[i].x;
    y = dataset[i].y;
    if(x >= x0 & x <= x1 & y >= y0 & y <= y1){
      console.log ("TRUE");
      selectedNames.push(i);
      selectedIDs.push(dataset[i].id); //collects selectedIDs
      hub.enableButton(recalculateRegression); //only if there are points will the button be enabled 
    }  
  } // for i

  if (selectedNames.length < 1) //when the selection is dragged to a place w/o points, this disables the button
   hub.disableButton(recalculateRegression) 
    
  console.log(" found " + selectedNames.length + " selected points");
   
} // getSelection
//--------------------------------------------------------------------------------
function sendingSelectedIDs(msg)
{
  console.log("sending Selected IDs"); 
  
  payload = {datasetName: "SouthSeattleHealthImpacts",
            dataframeName: "tbl.factors",
            feature1: feature1,
            feature2: feature2,
            leaveOut: selectedIDs}  

  callback= "replotRegressionLine";
    
  var returnMsg = {cmd:"correlateVectors", callback: callback, status: "success",
                    payload: payload};

  console.log(returnMsg);
  hub.send(JSON.stringify(returnMsg));

 
  hub.disableButton(recalculateRegression); //disables the button once it is clicked, requires a new selection to be enabled 

} // sendingSelectedIDs
//--------------------------------------------------------------------------------
function replotRegressionLine(msg)
{
  d3plotDiv.select("#secondLine").remove();  //so that the secondLine does not accumulate after every selection 
    
  console.log("replotting the regression line");
    
  payload = msg.payload;

  var dataset = []; 
  datasetLength = payload.vec1.length;

  for (var i=0; i<datasetLength; i++){
    dataset.push({x: payload.vec1[i], y: payload.vec2[i], id: payload.entities[i]});
  }

  var yFit = payload.yFit;
  var xFit = payload.vec1;
  var lastElement = datasetLength - 1;

  regressionLine2 = {x1: xFit[0], y1: yFit[0], x2: xFit[lastElement], y2: yFit[lastElement]};
  correlation2 = payload.correlation;   // between -1.0 and 1.0
  plotTitleDiv.html("<center> <i><b>" +
                     xAxisLabel + "</b></i> (x)  <i><b>vs.  " +
                     yAxisLabel + "</b></i> (y) </br>  &nbsp;  correlation: " +
                    correlation + "&nbsp; recalculated correlation: "
		    + correlation2 +  "</center>");

  displayingSecondLine(dataset, regressionLine2, correlation2)

}//replotRegressionLine	
//--------------------------------------------------------------------------------
function displayingSecondLine(dataset, regressionLine2, correlation)
{

  var width = plotDiv.width();
  var height = plotDiv.height();

  padding = 50;

  var xTranslationForYAxis = xScale(0);
  var yTranslationForXAxis = yScale(10);

  var tooltip = d3plotDiv.append("div")
                   .attr("class", "tooltip")
                   .style("position", "absolute")
                   .style("z-index", "10")
                   .style("visibility", "hidden")
                   .text("a simple tooltip");

  console.log("--- about to draw points, count: " + dataset.length);
  console.log(JSON.stringify(dataset))
	
  console.log("displaying second line"); 

 console.log(JSON.stringify(regressionLine2))

  //svg id is secondLine (that way it can be removed after every selection)
    
  svg.append("line")
    .attr("id", "secondLine")
    .style("stroke-width", 1)
    .style("stroke", "green")
    .attr("x1", xScale(regressionLine2["x1"]))
    .attr("y1", yScale(regressionLine2["y1"]))
    .attr("x2", xScale(regressionLine2["x2"]))
    .attr("y2", yScale(regressionLine2["y2"]));

}//displayingSecondLine	
//--------------------------------------------------------------------------------
function displayingNeighborhoodNames()
{
    console.log("displaying NeighborhoodNames");

    svg.selectAll("text")
	.data(dataset)
	.enter()
	.append("text")
	.text(function(d){
	    return d["id"];
	})
        .attr("x",function(d){
	    return d["x"];
	})
	.attr("y", function(d){
	    return d["y"];
	})
	.attr("font-family", "sans-serif")
	.attr("font-size", "15px")
	.attr("fill", "red");
	
}//displayingNeighborhoodNames	
//--------------------------------------------------------------------------------
function handleSelections(msg)
{
   console.log("--- Module.correlationPlots::handleSelections")
   console.log(msg)
   feature1 = msg.payload.value[0];
   feature2 = msg.payload.value[1];
   payload = {datasetName: datasetName,
              dataframeName: "tbl.factors",
              feature1: feature1,
              feature2: feature2}
   callback = "correlationPlot";
   newMsg = {cmd: "correlateVectors", status: "request", callback: callback, payload: payload}
   console.log("--- about to send correlation request");
   console.log(newMsg);

   hub.send(JSON.stringify(newMsg));

} // handleSelections
//--------------------------------------------------------------------------------
function datasetSpecified(msg)
{
   datasetName = msg.payload;
   console.log("corPlot, datasteSpecified, name: " + datasetName);
   console.log(msg);

   cmd = "getDatasetItemsByName";
   itemsRequested = ["tbl.factors", "tbl.neighborhoods"];

   var payload = {datasetName: datasetName, items: itemsRequested}
   var newMsg = {cmd: cmd,  callback: "storeData", status: "request", payload: payload};
   hub.send(JSON.stringify(newMsg));
    
} // datasetSpecified
//--------------------------------------------------------------------------------
function storeData(msg)
{
  console.log("--- Module.SSEF storeData");
  console.log(JSON.stringify(msg.cmd));
  factorsTable = msg.payload["tbl.factors"];
  neighborhoodNames = msg.payload["tbl.neighborhoods"].mtx; 
}// storeData
//--------------------------------------------------------------------------------
function plotCorrelation(msg)
{
   hub.enableTab("correlationPlotsDiv");
   hub.raiseTab("correlationPlotsDiv");
   console.log("--- Module.cor, plotCorrelation")
   console.log(JSON.stringify(msg));
   d3plotPrep (msg)

} // plotCorrelation
//--------------------------------------------------------------------------------
function initializeModule()
{
  hub.addOnDocumentReadyFunction(initializeUI);
    hub.addMessageHandler("datasetSpecified", datasetSpecified);
    hub.addMessageHandler("storeData", storeData); 
  hub.addMessageHandler("correlationPlot", plotCorrelation);
  hub.addMessageHandler("sendSelectionTo_correlationsPlotter", handleSelections);
  hub.addMessageHandler("replotRegressionLine",replotRegressionLine); 

} // initializeModule
//----------------------------------------------------------------------------------------------------
return{
   init: initializeModule
   };

//----------------------------------------------------------------------------------------------------
}); // CorrelationPlotsModule

corPlotsModule = CorrelationPlotsModule();
corPlotsModule.init();


//----------------------------------------------------------------------------------------------------

var EnvironmentalMapModule = (function () {

  var datasetName = null;
  //var auxSocketURL = "ws://localhost:9003";
  //var auxSocket;

  var environmentalMapsDiv;
  var enviroMapsControlsDiv;
  var rightControlsDiv; 
  var sourceDocsButton, plotCorrelationButton;

  var sendSelectionsMenu;
  var leftDataSelectionMenu, rightDataSelectionMenu;
  var DEFAULT_FILL_COLOR = "#FAFAFA";

  var thisModulesName = "EnvironmentalMap";
  var thisModulesOutermostDiv = "EnvironmentalMapDiv";

  var sendSelectionsMenuTitle = "Send selection...";

      // sometimes a module offers multiple selection destinations
      // but usually just the one entry point
  var selectionDestinations = [thisModulesName];
      // make sure to register, eg,
      // hub.addMessageHandler("sendSelectionTo_EnvironmentalMap", handleSelections);

  // The fact that the default projection's longitude is relative to
  // Hutchinson, KS threw me for a loop for a bit but then I realized I
  // just had to rotate the projection to my longitude, then center from
  // [0, latitude].  Like so, for anyone's future reference that needs a
  // projection of Austin, TX :-)
  // 30.2500° N, 97.7500°
  // seattle is 47.6097° N, 122.3331° W

  var goodScale = 220000;

  var projection = d3.geo.albers()
     .scale(goodScale)
     .rotate ([122.3331, 0])
     .center([0, 47.6097])
     .translate([300, 200]);

  var path;
  var mapTooltipDiv;
  var leftMapDiv, rightMapDiv;

  var dataTable;
  var mapLeftSVG, mapRightSVG;
    
  var w; var h; 

//--------------------------------------------------------------------------------------------
function initializeUI()
{
  $(window).resize(handleWindowResize);

  plotCorrelationButton = $("#plotCorrelationButton");
  plotCorrelationButton.click(requestCorrelation);
  hub.disableButton(plotCorrelationButton);

  leftDataSelectionMenu = $("#leftDataCategorySelector");
  leftDataSelectionMenu.change(function(){displayCategory(mapLeftSVG, leftDataSelectionMenu)});
  rightDataSelectionMenu = $("#rightDataCategorySelector");
  rightDataSelectionMenu.change(function(){displayCategory(mapRightSVG, rightDataSelectionMenu)})

  d3mapLeftDiv = d3.select("#leftMapDiv")
  d3mapRightDiv = d3.select("#rightMapDiv")


  environmentalMapsDiv = $("#environmentalMapsDiv");
  enviroMapsControlsDiv = $("#enviroMapsControlsDiv");
  rightControlsDiv=$("#rightControlsDiv"); 

  leftMapDiv = $("#leftMapDiv");
  rightMapDiv = $("#rightMapDiv");

  sourceDocsButton = $("#enviroMapsSourceDocumentButton")
  sourceDocsButton.click(showSourceDocs);
  //displayLeftMap();
  //displayRightMap();

  //sendSelectionsMenu = hub.configureSendSelectionMenu("#environmentalMapSendSelectionsMenu",
  //                                                    selectionDestinations,
  //                                                    sendSelections,
  //                                                    sendSelectionsMenuTitle);

    initializeViewBox();
    
} // initializeUI
//----------------------------------------------------------------------------------------------------
function initializeViewBox()
{
  handleWindowResize();

  var controlsDivHeight = 20;

  var mapWidth = (environmentalMapsDiv.width() * 0.9); 
  var mapHeight = (0.95 * environmentalMapsDiv.height()) - controlsDivHeight;
    
  var svg1 = $("#leftMapDiv").get(0);
  svg1.setAttribute('viewBox', '0 0 ' + mapWidth + ' '+ mapHeight);
  svg1.setAttribute('preserveAspectRatio', 'xMidYMid meet');


  var svg2 = $("#rightMapDiv").get(0);
  svg2.setAttribute('viewBox', '0 0 ' + mapWidth + ' ' + mapHeight);
  svg2.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    
  var leftDiv = $("#leftMap").get(0);
  leftDiv.style.width = mapWidth*1.1;
  leftDiv.style.width = mapHeight*1.1;

  var rightDiv = $("#rightMap").get(0);
  rightDiv.style.width = mapWidth;
  rightDiv.style.width = mapHeight; 
    

} // initializeViewBox
//----------------------------------------------------------------------------------------------------
function setupSpecialSocket(websocket)
{
  console.log("entering setupSpecialSocket")

  websocket.onopen    = function(evt) {onOpen(evt) };
  websocket.onclose   = function(evt) {onClose(evt) };
  websocket.onmessage = function(evt) {onMessage(evt) };
  websocket.onerror   = function(evt) {onError(evt) };
}
//----------------------------------------------------------------------------------------------------
handleWindowResize = function()
{
   var controlsDivHeight = 20;
   var windowWidth = $(window).width();
   var windowHeight = $(window).height();

   environmentalMapsDiv.height(windowHeight * 0.95)
   environmentalMapsDiv.width(windowWidth * 0.475)

   enviroMapsControlsDiv.height(controlsDivHeight);
   enviroMapsControlsDiv.width(environmentalMapsDiv.width() * 0.95);

   rightControlsDiv.height(controlsDivHeight);
   rightControlsDiv.width(environmentalMapsDiv.width() * 0.95); 
    

   var mapWidth = environmentalMapsDiv.width() * 0.9;
   var mapHeight = (0.95 * environmentalMapsDiv.height()) - controlsDivHeight;

   leftMapDiv.width(mapWidth);
   leftMapDiv.height(mapHeight);
   rightMapDiv.width(mapWidth);
   rightMapDiv.height(mapHeight);

   var tx = leftMapDiv.width()/2;
   var ty = leftMapDiv.height()/2;

    // derive scaling constant empircially
    //------------------------------------------
    // mapDiv height    projection.scale
    //  1000             150,000
    //   500              75,000
    //    h
    //  150000 = 150000 * h/1000

   var newScale = 150000 * (mapHeight/1000)
   projection.translate([tx, ty]).scale(newScale);

    if(typeof(mapLeftSvg) != "undefined"){
      mapLeftSVG.attr("width", mapWidth).attr("height", mapHeight);
      mapLeftSVG.selectAll('path').attr('d', path);
      displayText(mapLeftSVG);
      }

   if(typeof(mapRightSvg) != "undefined"){
      mapRightSVG.attr("width", mapWidth).attr("height", mapHeight);
      mapRightSVG.selectAll('path').attr('d', path);
      displayText(mapRightSVG);
   }
   
} // handleWindowResize
//----------------------------------------------------------------------------------------------------
function showSourceDocs()
{
   var sourceDoc = "http://justhealthaction.org/wp-content/uploads/2013/03/CHIA-EPA-TRI-Conference-DC-May-2014.pdf"
   window.open(sourceDoc);
   var sourceDoc2 = "http://duwamishcleanup.org/wp-content/uploads/2013/03/CHIA_AppendixA_lowres.pdf"
   window.open(sourceDoc2);

} // showSourceDocs
//----------------------------------------------------------------------------------------------------
function requestCorrelation()
{
  var cmd = "correlateVectors";
  var leftCategory = leftDataSelectionMenu.val();
  var rightCategory = rightDataSelectionMenu.val();
  var cmd = "sendSelectionTo_" + "correlationsPlotter";

  payload = {value: [leftCategory, rightCategory], count: 2, source: thisModulesName};
  var newMsg = {cmd: cmd,  callback: "", status: "request", payload: payload};
  hub.send(JSON.stringify(newMsg));

} // requestCorrelation
//----------------------------------------------------------------------------------------------------
function sendSelections(event)
{
  var destination = sendSelectionsMenu.val();

  var cmd = "sendSelectionTo_" + destination;
  var dummySelections = ["dummy selection 1", "dummy selection 2"];

  payload = {value: dummySelections, count: dummySelections.length,
             source: thisModulesName};

  var newMsg = {cmd: cmd,  callback: "", status: "request", payload: payload};

  // restore default (informational) title of the menu
  sendSelectionsMenu.val(sendSelectionsMenuTitle);

  hub.send(JSON.stringify(newMsg));

} // sendSelections
//--------------------------------------------------------------------------------------------
function datasetSpecified(msg)
{
   console.log("--- Module.cleveland:  datasetSpecified: " + msg.payload);
   hub.enableTab("environmentalMapsDiv");

   datasetName = msg.payload;

   cmd = "getDatasetItemsByName";
   itemsRequested = ["tbl.factors", "tbl.neighborhoods", "zipCodes"];
   callback = "southSeattleEnvironmentalFactorsStoreAndDisplayData";

   var payload = {datasetName: datasetName, items: itemsRequested}
   var newMsg = {cmd: cmd,  callback: callback, status: "request", payload: payload};
   hub.send(JSON.stringify(newMsg));

} // datasetSpecified
//----------------------------------------------------------------------------------------------------
function loadData(msg)
{
   console.log("Module.cleveland, loadData");
   var cmd = "getRegisteredMessageNames";
   var callback = "southSeattleEnvironmentalFactorsStoreAndDisplayData";
   var payload = "SouthSeattleHealthImpacts";
   var newMsg = {cmd: cmd,  callback: callback, status: "request", payload: payload};

   hub.send(JSON.stringify(newMsg));

} // loadData
//--------------------------------------------------------------------------------------------
function storeAndDisplayData(msg)
{
   console.log("---- Module.SSEF storeAndDisplayData");
   console.log(JSON.stringify(msg.cmd));
   zipCodes = JSON.parse(msg.payload["zipCodes"]);
   factorsTable = msg.payload["tbl.factors"];
   neighborhoodLabels = msg.payload["tbl.neighborhoods"].mtx


     // this next step is confusing.  herewith an attempt to explain
     // we have module variables for the div (defined in widget.html)
     // into which d3 inserts an svg element
     // there are two maps, and two different variables for each:
     //   jQuery variable: we use this for window resize events
     //   a d3 variable: we use this to append and remove the svg element
     // both variables are instantiated with the same html '#' tag
     // we always want to remove any pre-existing svg element so that
     // successive calls to create maps do not accumulate svgs, accumulate maps

   mapLeftSVG  = createMap("#leftMapDiv",  "#leftDataCategorySelector",  zipCodes, factorsTable);
   mapRightSVG = createMap("#rightMapDiv", "#rightDataCategorySelector", zipCodes, factorsTable);
   hub.raiseTab("environmentalMapsDiv");
   handleWindowResize();  // resizes widgets appropriately

} // storeAndDisplayData
//--------------------------------------------------------------------------------------------
function handleSelections(msg)
{
   hub.raiseTab(thisModulesOutermostDiv);
   var msgAsString = JSON.stringify(msg.payload);

   outputDiv.html("<pre>" + msgAsString + "</pre");

} // handleSelections
//----------------------------------------------------------------------------------------------------
function calculateColor(normalizedValue)
{

  var redColors = ["#FFF0F0", "#FFCCCC", "#FFB3B3", "#FF9999", "#FF8080",
                   "#FF6666", "#FF4D4D", "#FF3333", "#FF1A1A", "#FF1010", "#FF0000"];

  if(normalizedValue == undefined)
    return(DEFAULT_FILL_COLOR);

  if(isNaN(normalizedValue))
    return(DEFAULT_FILL_COLOR);

  return(redColors[normalizedValue])

} // calculateColor
//----------------------------------------------------------------------------------------------------
function displayCategory(mapSVG, categoryMenu)
{
   var leftCategory = leftDataSelectionMenu.val();
   var rightCategory = rightDataSelectionMenu.val();
   if(leftCategory.length > 0 && rightCategory.length > 0)
      hub.enableButton(plotCorrelationButton);
   else
      hub.disableButton(plotCorrelationButton);

  leftDataSelectionMenu.change(function(){displayCategory(mapLeftSVG, leftDataSelectionMenu)});
  rightDataSelectionMenu = $("#rightDataCategorySelector");

   var dataCategory = categoryMenu.val();
   console.log(" new data category: " + dataCategory);

   var dataTable = factorsTable;
   var rowIndex = dataTable.colnames.indexOf(dataCategory);
      // mtx is an array of columns, one colum for each zip code region
      // we need to extract one element from each
   var mtx = dataTable.mtx;
   var regionNames = dataTable.rownames;   // currently zip codes
   var data = [];                          // counts for each zip code for current dataCategory
   mtx.forEach(function(columnVector){data.push(columnVector[rowIndex])});

   var min = d3.min(data);
   var max = d3.max(data);
   var scalingFunction = d3.scale.linear().domain([min, max]).range([0,10]);

      // loop over all of the elements (all paths delineating zip code areas).
      // these are returned as element "d", with has the values as
      // originally defined from the loaded data which, in this case,
      // is an object with keys "type" and properties
      // the properties sub-object has keys which include "GEOID10" and "geometry"
      // d.properties.GEOID10 is the zipCode, which allows us to index into
      // the factorsTable, which has, for the selected dataCategory,
      // numerical values for 10 of the ~28 zipcodes on the map
      // we normalize that value to something between 0 and 10, then
      // look up the color associated with the normalized value

      // we also specify the tooltip text to display, using the same technique:
      // 'd' is the d3 representation of the original map element, the one
      // over which the mouse is hovering.  we get the GEOID10, look up the
      // the un-normalized value, then display zip code name, dataCategory name
      // and value in the tooltip

   mapSVG.selectAll("path")
       .style("fill", function(d) {
            var zipCode = d.properties.GEOID10;
            var zipCodeIndex = regionNames.indexOf(zipCode);
            //console.log("zipCode: " + zipCode + "  index: " + zipCodeIndex);
            //console.log(JSON.stringify(d));
            if(zipCodeIndex >= 0){
               var rawValue = data[zipCodeIndex];
               //console.log("rawValue: " + rawValue);
               var normalizedValue = Math.round(scalingFunction(rawValue));
               return calculateColor(normalizedValue);
               }
            else{
               return DEFAULT_FILL_COLOR;
               }
            })
       .on("mouseover", function(d) {
          d3.select(this).transition().duration(300).style("opacity", 1);
          mapsTooltipDiv.transition().duration(300)
             .style("opacity", 1)
          var zipCode = d.properties.GEOID10;
          var zipCodeIndex = regionNames.indexOf(zipCode);
          var value = data[zipCodeIndex];
          var dataCategoryFixed = dataCategory.replace(/\./gi, " ");
          var msg = zipCode + '\n' + dataCategoryFixed + ": " + value;
          console.log("mouseover msg: " + msg);
          if(value == undefined)
             msg = zipCode;
          mapsTooltipDiv.text(msg)
             .style("left", (d3.event.pageX) + "px")
             .style("top", (d3.event.pageY + 30) + "px");
             }) // on mouseover

	.on("mouseout", function() {
          d3.select(this)
            .transition().duration(300)
            .style("opacity", 0.8);
          mapsTooltipDiv.transition().duration(300)
             .style("opacity", 0);
         }) // on mouseout
       .on("click", function(){
          console.log("--- mouseclick");
          console.log(this);
       });



    mapSVG.selectAll("g.neighborhoodLabel")
	.on("mouseover", function(d){
	    d3.select(this).transition().duration(300).style("opacity", 1);
	     mapsTooltipDiv.transition().duration(300)
             .style("opacity", 1)
          var zipCode = d[0]; 
          var zipCodeIndex = regionNames.indexOf(zipCode);
          var value = data[zipCodeIndex];
          var dataCategoryFixed = dataCategory.replace(/\./gi, " ");
          var msg = zipCode + '\n' + dataCategoryFixed + ": " + value;
          console.log("mouseover msg: " + msg);
          if(value == undefined)
             msg = zipCode;
          mapsTooltipDiv.text(msg)
             .style("left", (d3.event.pageX) + "px")
             .style("top", (d3.event.pageY + 30) + "px");
        }) // on mouseover
    	.on("mouseout", function() {
          d3.select(this)
            .transition().duration(300)
            .style("opacity", 0.8);
          mapsTooltipDiv.transition().duration(300)
             .style("opacity", 0);
         }) // on mouseout
    

} // displayCategory
//----------------------------------------------------------------------------------------------------
function createMap(mapDivTag, selectorMenuTag, zipCodes, factorsTable)
{
  console.log("--- entering createMap");
  path = d3.geo.path().projection(projection);

   // remove any prior svg element, so that these do not accumulate
  d3.select(mapDivTag).select("svg").remove();

  svg = d3.select(mapDivTag).append("svg")
	.attr("width", leftMapDiv.width()) // width)
	.attr("height", leftMapDiv.height()); //height)


  mapsTooltipDiv = d3.select('body').append("mapsTooltipDiv")
                            .attr("class", "mapsTooltip")
                            .style("opacity", 0);

  dataTable = factorsTable;
  var categories = dataTable.colnames

     // populate the pulldown menu
  for(var i=0; i < categories.length; i++){
     //console.log(categories[i]);
     var optionString = "<option value='" + categories[i] + "'>" + categories[i] + "</option>";
     $(selectorMenuTag).append(optionString);
     } // for i

  svg.selectAll("path")
       .data(zipCodes.features)
       .enter()
       .append("path")
       .attr("d", path)
       .style('stroke', 'black')
       .style('stroke-width', 0.2)
       .style("fill", DEFAULT_FILL_COLOR)
       .on("mouseover", function(d) {
          d3.select(this).transition().duration(300).style("opacity", 1);
          mapsTooltipDiv.transition().duration(300)
             .style("opacity", 1)
          var id = d.properties.GEOID10;
          mapsTooltipDiv.text(id)
             .style("left", (d3.event.pageX) + "px")
             .style("top", (d3.event.pageY + 30) + "px");
             }) // on mouseover
       .on("mouseout", function() {
          d3.select(this)
            .transition().duration(300)
            .style("opacity", 0.8);
          mapsTooltipDiv.transition().duration(300)
             .style("opacity", 0);
         }) // on mouseout

   console.log("about to call displayText");
   displayText(svg);
   return(svg)

} // displayMap
//----------------------------------------------------------------------------------------------------
// a lot of this seems like magic, the logic not clear...
function displayText(mapSVG, zipCodes, factorsTable)
{
    // first delete
  mapSVG.selectAll("g.neighborhoodLabel").remove();


  var neighborhood =  mapSVG.selectAll("g.neighborhood")
      .data(neighborhoodLabels)
      .enter()
      .append("g")
      .attr("class", "neighborhoodLabel")
      .attr("transform", function(d) {
          //console.log("d.lon, d.lat" + d.lon + ", " + d.lat);
          console.log(JSON.stringify(d))
          console.log("long, d[3]: " + d[3]);
          console.log("lat,  d[2]: " + d[2]);
          return "translate(" + projection([ d[2], d[3]]) + ")";
    })
      .attr("d", path)
      .on("mouseover", function(d) {
	  d3.select(this).transition().duration(300).style("opacity", 1);
	  mapsTooltipDiv.transition().duration(300)
	      .style("opacity", 1)
	  var id = d[0];
	  mapsTooltipDiv.text(id)
	      .style("left", (d3.event.pageX) + "px")
	      .style("top", (d3.event.pageY + 30) + "px");
      }) // on mouseover
    
      .on("mouseout", function() {
	  d3.select(this)
	      .transition().duration(300)
	      .style("opacity", 0.8);
	  mapsTooltipDiv.transition().duration(300)
              .style("opacity", 0);
      }) // on mouseout;
    
    neighborhood.append("text")
	.text(function(d){
	    console.log("adding text: " + d[1]);
	    return d[1];
	});

} // displayText
//----------------------------------------------------------------------------------------------------
function getLeftDataCategory(msg)
{
  category = leftDataSelectionMenu.val()
  
  console.log("disabled! sending " + category + " back to jupyter?");
  var msg = {cmd: "handleResponse", callback: "", status: "successful", payload: category};

  //auxSocket.send(JSON.stringify(msg));

} // getLeftDataCategory
//----------------------------------------------------------------------------------------------------
function initializeModule()
{
   //hub.registerSelectionDestination(selectionDestinations, thisModulesOutermostDiv);

  hub.addOnDocumentReadyFunction(initializeUI);
  hub.addMessageHandler("datasetSpecified", datasetSpecified);
   //hub.addMessageHandler("sendSelectionTo_EnvironmentalMap", handleSelections);
  hub.addMessageHandler("southSeattleEnvironmentalFactorsStoreAndDisplayData", storeAndDisplayData)
  hub.addMessageHandler("ssEFgetLeftDataCategory", getLeftDataCategory);
   //hub.addSocketConnectedFunction(loadData);

   //auxSocket = new WebSocket(auxSocketURL);


} // initializeModule
//----------------------------------------------------------------------------------------------------
return{
   init: initializeModule
   }; // environmentalMapModule return value

//----------------------------------------------------------------------------------------------------
}); // EnvironmentalMapModule

enviroMapModule = EnvironmentalMapModule();
enviroMapModule.init();


//----------------------------------------------------------------------------------------------------
var ClevelandCreditsModule = (function () {

//--------------------------------------------------------------------------------
function datasetSpecified(msg)
{
   console.log("ClevelandCreditsModule gets datasetSpecified message");
   hub.enableTab("clevelandCreditsDiv")

} // datasetSpecified
//--------------------------------------------------------------------------------
function initializeModule()
{
  hub.addMessageHandler("datasetSpecified", datasetSpecified);

} // initializeModule
//----------------------------------------------------------------------------------------------------
return{
   init: initializeModule
   };

//----------------------------------------------------------------------------------------------------
}); // ClevelandCreditsModule

clevelandCreditsModule = ClevelandCreditsModule();
clevelandCreditsModule.init();


//----------------------------------------------------------------------------------------------------
var DataTableModule = (function () {

  var datasetName = null;

  var dataset;                 // assigned from payload of incoming plotxy message
  var datasetLength;

  var thisModulesName = "DataTable";
  var thisModulesOutermostDiv = "DataTableDiv";

  var contentDiv;

//--------------------------------------------------------------------------------------------
function initializeUI(){
  contentDiv = $("#dataTableContentDiv")
  $(window).resize(handleWindowResize);
  handleWindowResize();

  dataTableDiv=$("dataTableDiv");
  dataTableControlsDiv=$("dataTableControlsDiv");

}  // initializeUI
//----------------------------------------------------------------------------------------------------
function handleWindowResize (){
  contentDiv.width(0.95 * $(window).width());
  contentDiv.height(0.80 * $(window).height());

} // handleWindowResize
//--------------------------------------------------------------------------------
function datasetSpecified(msg){

  console.log("--- Module.cleveland: datasetSpecified: " + msg.payload);
  hub.enableTab("dataTableDiv");
    
  datasetName = msg.payload;

  console.log("dataTableModule, datasetSpecified, name: " + datasetName);
  console.log(msg);

  cmd="getDatasetItemsByName";
  itemsRequested=["tbl.factors", "zipCodes"];
  callback="displayDataTable";

  var payload={datasetName: datasetName, items: itemsRequested}
  var newMsg={cmd: cmd, callback: callback, status:"request", payload:payload};
  hub.send(JSON.stringify(newMsg)); 

} // datasetSpecified
//--------------------------------------------------------------------------------
function loadData(msg){
  console.log("Module.cleveland, loadData");
  var cmd = "getRegisteredMessagesNames";
  var callback="displayDataTable";
  var payload="SouthSeattleHealthImpacts";
  var newMsg= {cmd: cmd, callback: callback, status: "request", payload: payload};

  hub.send(JSON.stringify(newMsg));
}
    
//--------------------------------------------------------------------------------
function displayDataTable(msg){
  console.log("displayDataTable");
    
  console.log("---- Module.SSEF displayDataTable");
  console.log(JSON.stringify(msg.cmd));
  zipCodes=JSON.parse(msg.payload["zipCodes"]);   
  factorsTable = msg.payload["tbl.factors"];
  //columnTitles = factorsTable.colnames;
  //rowTitles = factorsTable.rownames;

  display = tableDisplay("#dataSetTable", zipCodes,  factorsTable);
 	
} // displayDataTable
//--------------------------------------------------------------------------------
function tableDisplay(divTag, zipCodes, factorsTable){

  console.log(" ---- entering tableDisplay");
  var columnTitles = factorsTable.colnames;
  var rowTitles = factorsTable.rownames;
  var matrix = factorsTable.mtx; 
  columnTitles.unshift("Zip Code"); 
    var dataSet= matrix;

  console.log(zipCodes); 
  
  console.log(dataSet); 
  console.log(columnTitles);
  console.log(factorsTable.rownames); 

  var columnTitlesInOrder =[];
  for (var i=0; i <columnTitles.length; i++){
    columnTitlesInOrder.push({title: columnTitles[i]});}

  for(i=0; i<rowTitles.length; i++){
    dataSet[i].unshift(rowTitles[i])}

  $(function(){
    console.log("document ready"); 
      $('#dataSetTable').DataTable({
        dom: 'Bfrtip',
          buttons:[ {extend: 'collection', text:'Export',
		     buttons: [
			 'copy',
			 { text: 'TSV',
			   extend: 'csvFlash',
			   filename: 'Data export',
			   fieldSeparator: '\t',
			   extension: '.tsv'
			 },
			 { extend: 'csvFlash',
			   filename: 'Data export',
			   exportOptions: {columns: ':visible'},
			   exportData: {decodeEntities:true}
			 },
			 { extend: 'excelFlash',
			   filename: 'Data export'
			 },
			 'print']
		    }
		  ], 
          "bPaginate": false,
	  "bInfo": false, 
	  "bFilter": false,
	  data: dataSet, 
	columns: columnTitlesInOrder
      }); 
  }); 

} //tableDisplay
//--------------------------------------------------------------------------------
function initializeModule(){
  hub.addOnDocumentReadyFunction(initializeUI);
  hub.addMessageHandler("datasetSpecified", datasetSpecified);
  hub.addMessageHandler("displayDataTable", displayDataTable); 

} // initializeModule
//----------------------------------------------------------------------------------------------------
return{
  init: initializeModule

};
//----------------------------------------------------------------------------------------------------
}); // DataTableModule

dataTableModule = DataTableModule();
dataTableModule.init();

</script>

<!--Datatables --> 
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
<!--Export Buttons-->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.2.1/css/buttons.dataTables.min.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.2.1/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.2.1/js/buttons.flash.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.2.1/js/buttons.html5.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.2.1/js/buttons.print.min.js"></script>

<div id="chinookTabs">
   <ul>
     <li><a href="#datasetsDiv">Datasets</a></li>
     <li><a href="#clevelandCreditsDiv">Credits</a></li>
     <li><a href="#environmentalMapsDiv">Maps</a></li>
     <li><a href="#correlationPlotsDiv">Correlation Plot</a></li>
     <li><a href="#dataTableDiv"> Tabular View </a></li>
   </ul>

<style>
</style>

<div id="datasetsDiv" style="height:auto">
  <div id="datasetsStatusDiv" style="display:none"></div>
  <div id="dataSummaryControlsDiv">
     <span id="selectDatasetMenuLabel" style="margin-left: 20px;">Available Datasets</span>
     <select type="button" id="datasetMenu" style="margin: 5px;"><option> </option></select>
     <button id="selectDatasetButton">Use Dataset</button>
	 <span id="loadingDatasetMessage" style="display:none; margin-left:10px">Loading Dataset...</span>
     <select type="button" id="datasetsSendSelectionsMenu" style="float:right; margin:15px; display: none"></select>
    <!-- div id="oncoscapeLogo" style="float:right; margin-right:0.5em">
       <img width="175" src="http://oncoscape.sttrcancer.org/oncoscape/images/oncoscape_logo_TM.png" alt="Oncoscape"/>
     </div -->
  </div>

   <div id="dataSetNamesOutputDiv" style="margin: 20px;"></div>

   <div id="dataSummaryOutputDiv" style="margin: 20px;overflow-x:auto">
      <div id="datasetInstructions">Please select a dataset from the above menu.</div>
      <table id="datasetsManifestTable" class="display" cellpadding="0" cellspacing="0" style="margin:0px; width:auto; display:none; border:none"></table>
   </div>
</div>

<div id="clevelandCreditsDiv">

<center>
<h2>Background and Credits</h2>
</center>

<div style="margin:100px">
Data presented here were collected and analzyed by Linn Gould of <a href="http://justhealthaction.org/">Just Health Action</a> and BJ Cummings of the
<a href="http://duwamishcleanup.org/">Duwamish River Cleanup Coalation</a> with funding from the US Environmental Protection Agency, and published
as part of
<p>

  <b>Gould, Linn, and B. J. Cummings. <a href="http://justhealthaction.org/wp-content/uploads/2013/03/Duwamish-Valley-Cumulative-Health-Impacts-Analysis-Seattle-WA.pdf">Duwamish Valley Cumulative
  Health Impacts Analysis: Seattle, Washington.</a>  2013.</b>
<p>
<center> <h4>Executive Summary</h4></center>

South Seattle's Duwamish Valley has long been referred to as a community with environmental
injustices - a community with disproportionately high environmental health burdens and risks
and fewer positive environmental benefits than the rest of Seattle—but limited evidence has been
available to date to validate or quantify this characterization. The Duwamish River Cleanup Coalition/
Technical Advisory Group (DRCC/TAG) received an Environmental Justice (EJ) Research grant
from EPA to conduct a Cumulative Health Impacts Analysis (CHIA) to document and quantify the
Duwamish Valley's environmental health status relative to other areas of Seattle. Cumulative impacts
are defined as: "any exposures, public health, or environmental effects from the combined emissions
and discharges, in a geographic area, including environmental pollution, from all sources, whether
single or multimedia, routinely, accidently, or otherwise released" (OEHHA, 2010).
In accordance with California EPA’s cumulative impacts ranking methodology, a total of 15 indicators
in five categories were selected and input into a formula to calculate cumulative heath impact scores
for ten representative Seattle ZIP codes. Indicators included socioeconomic factors; sensitive populations;
environmental exposures; environmental effects; and public health effects (OEHHA, 2010).
From an environmental exposures perspective, Beacon Hill/Georgetown/South Park (ZIP code 98108)
had the highest ranking for air pollution and for exposure to confirmed and suspected contaminated
sites. This area also had one of the highest rankings in the city for unhealthy environmental effects,
i.e., lack of access to a healthy built environment. Cumulatively, these poor environmental scores combined
with high ranks for social vulnerabilities (socioeconomic factors and sensitive populations) and
a medium ranking for public health effects resulted in the highest cumulative impact score of Seattle
ZIP codes in the study. The results of this cumulative analysis provide a firm basis for characterizing
the Duwamish Valley as an area with disproportionate health impacts and environmental injustices.
Additional evidence, including at the larger Duwamish watershed scale and at the smaller census tract
scale, reinforce these cumulative findings, and further suggests that the ZIP code level analysis may
obscure even greater disparities in the riverside communities of South Park and Georgetown. In
comparing residents of the Duwamish Valley to King County, Duwamish Valley residents are more
likely to live in poverty, be foreign born, have no health insurance or leisure time, and are more likely
to be sick. Georgetown and South Park residents have up to a 13-year shorter life expectancy (at birth)
than wealthier parts of Seattle.
<p>

In light of these cumulative findings, the Duwamish Valley merits attention from decision-makers regarding
health protective and proactive environmental regulations, policies, practices, and actions. The
results of this analysis will inform recommendations that DRCC/TAG will make to EPA, Washington
state, and local government agencies regarding the Lower Duwamish River Superfund Site. In addition,
DRCC/TAG will provide this report to federal, state, regional, and local governments; community-based
organizations; and other stakeholders and decision-makers, to help guide the development of
policies and actions to improve overall environmental health and equity in the Duwamish Valley.

</div>

</div>


<div id="correlationPlotsDiv">
   <div id="correlationPlotsControlsDiv"></div>
   <div id="correlationPlotTitleDiv"></div>
   <div id="correlationPlottingDiv"></div>
   <div id="correlationButton">
     <button id="recalculateRegression">Recalculate Regression</button>
     <button id="displayNeighborhoodNames"> Neighborhood Names </button> 
   </div> 
</div>

<style>
.mapsTooltip {
  position: absolute;
  text-align: center;
  width: 150px;
  height: 60px;
  padding: 2px;
  font-size: 12px;
  background: white;
  border: 1px;
  border-style: solid;
  border-radius: 8px;
  border-color: gray;
  pointer-events: none;
  white-space:pre; 
}
#leftMap{
  margin-top:20px;
  margin-left: 20px ; 
  border-style:solid;
  border-color:#a00;
border-width: 1px;
width: 95%;
height: 78%;
}
#rightMap{
  margin-top:20px;
  margin-left: 20px ;
  border-style:solid;
  border-color:#00a;
border-width: 1px;
width: 95%;
height: 78%; 
}

</style>


<div id="environmentalMapsDiv">
    <table>
      <tr>
        <td style="width:50%">
           <div id="enviroMapsControlsDiv" style="margin-top: 5px">
             <label for="leftDataCategorySelector" style="margin:5px; font-size:14px">Select:</label>
             <select id="leftDataCategorySelector" name="dataCategorySelector" class="selectorClass">
                <option val=""></option>
             </select>
           </div>
	   <div id="leftMap">
	     <svg id="leftMapDiv"></svg>
	   </div> 
        </td>
        <td style="width:50%">
           <div id="rightControlsDiv" style="margin-top: 5px">
              <label for="rightDataCategorySelector" style="margin:5px; font-size:14px">Select:</label>
              <select id="rightDataCategorySelector" name="dataCategorySelector" class="selectorClass">
                 <option val=""></option>
              </select>
                <button id="plotCorrelationButton" style="float:right; font-size: 10px">Correlation</button>
                <button id="enviroMapsSourceDocumentButton" style="float:right; font-size: 10px">Source Docs</button>
	   </div>
	   <div id="rightMap"> 
	     <svg id="rightMapDiv"></svg>
	   </div>
        </td>
      </tr>
    </table>
</div>

    

<div id="dataTableDiv">
   <div id="dataTableControlsDiv" style="margin: 40px; margin-right:160px"></div>
   <div id="dataTableContentDiv" style="overflow:scroll; height:100%px; width:50%; overflow:auto">
     <table id="dataSetTable" class="display" cellspacing="0" width="auto"></table>
   </div>
</div>
   
</div>

</body>
</html>
